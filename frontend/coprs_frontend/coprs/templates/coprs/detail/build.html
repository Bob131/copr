{% extends "coprs/detail.html" %}
{% from "coprs/detail/_builds_forms.html" import copr_build_cancel_form, copr_build_repeat_form, copr_build_delete_form %}
{% from "coprs/detail/_describe_source.html" import describe_source %}
{% block title %}Build {{ build.id }} in {{ build.copr.owner.name }}/{{ build.copr.name }}{% endblock %}
{%block project_breadcrumb %}
<li>
  <a href="{{ url_for('coprs_ns.copr_builds', username=copr.owner.name, coprname=copr.name) }}">Builds</a>
</li>
<li class="active">
  {{build.id}}
</li>
{%endblock%}

{% block detail_body %}

{% if build.copr != copr %}
<h2 class="build-detail"> Build {{ build.id }} doesn't belong to this project. </h2>
<p> You can go to <a href="{{url_for("coprs_ns.copr_build", username = build.copr.owner.name, coprname = build.copr.name, build_id = build.id)}}"> {{ build.copr.owner.name }}/{{ build.copr.name }}/build/{{build.id}} </a>to see this build. </p>
{% else %}

<h2> Build {{ build.id }}: <span class="build-{{build.state}}"> {{ build.state }} </span> </h2>

<div class="row">
  <div class="col-sm-8 col-md-9">
    <dl class="dl-horizontal">
      <dt> Package Name:</dt>
      <dd>
        {% if build.package %} 
          <a href="{{url_for('coprs_ns.copr_package', username=build.copr.owner.name, package_name=build.package.name, coprname=copr.name)}}">
            {{ build.package.name }}
          </a>
        {% else %}
             - 
        {% endif %}
      </dd>
      <dt> Package Version:</dt>
      <dd>
        {% if build.pkg_version %} 
            {{ build.pkg_version}}
        {% else %}
             - 
        {% endif %}
      </dd>
      <dt> Built by: </dt>
      <dd>
        <a href="{{ url_for('coprs_ns.coprs_by_owner', username=build.user.name) }}">
          {{ build.user.name }}
        </a>
      </dd>
      <dt> Submitted: </dt>
      <dd>
        {% if g.user %}
            {{ build.submitted_on|localized_time(g.user.timezone) }}
        {% else %}
            {{ build.submitted_on|localized_time("UTC") }}
        {% endif %}
        ({{ build.submitted_on|time_ago }} ago)
      </dd>
      <dt> Started: </dt>
      <dd>
        {% if g.user %}
            {{ build.min_started_on|localized_time(g.user.timezone) }}
        {% else %}
            {{ build.min_started_on|localized_time("UTC") }}
        {% endif %}
      </dd>
      <dt> Finished: </dt>
      <dd>
        {% if g.user %}
            {{ build.max_ended_on|localized_time(g.user.timezone) }}
        {% else %}
            {{ build.max_ended_on|localized_time("UTC") }}
        {% endif %}
      </dd>
      <dt> Build time: </dt>
      <dd>
        {{ build.min_started_on|time_ago(build.max_ended_on) }}
      </dd>
      <dt> Networking enabled: </dt>
      <dd>
          {{ build.enable_net }}
      </dd>
    </dl>

    <h3> Build Source </h3>
    {{ describe_source(build) }}

    <h3> Chroot Details </h3>
    <table class="table table-striped table-bordered">
      <thead>
        <tr>
          <th>Name</th>
          <th>Source (Git Hash)</th>
          <th>Build Time</th>
          <th>State</th>
        </tr>
      </thead>
      <tbody>
      {% for chroot in build.build_chroots %}
        <tr>
          <td>
            {% if build.results %}
            <a href="{{ build.results }}/{{ chroot.name }}/{{build.result_dir_name}}">{{ chroot.name }}</a>
            {% else %}
            {{ chroot.name }}
            {% endif %}
          </td>
          <td>
            {{ chroot.git_hash }}
          </td>
          <td>
            {{ chroot.started_on|time_ago(chroot.ended_on) }}
          </td>
          <td>
            <span class="build-{{chroot.state}}" alt="{{chroot.state|build_state_description}}">
              {{ chroot.state }}
            </span>
          </td>
        </tr>
      {% endfor %}
      </tbody>
    </table>


  </div>
  <div class="col-sm-4 col-md-3">
  {% if g.user and g.user.can_build_in(copr) %}
  <div class="panel panel-default">
    <div class="panel-heading">
      <h3 class="panel-title"> Actions </h3>
    </div>
    <ul class="list-group">
    {% if g.user and g.user.can_build_in(copr) and build.cancelable %}
      <li class="list-group-item">
        {{ copr_build_cancel_form(build, page) }}
      </li>
    {% endif %}

    {% if g.user and g.user.can_build_in(copr) and build.repeatable %}
      <li class="list-group-item">
        {{ copr_build_repeat_form(build, page) }}
      </li>
    {% endif %}

    {% if g.user and g.user.can_build_in(copr) and build.deletable %}
    {% if g.user.can_edit(copr) or build.user == g.user %}
      <li class="list-group-item">
        {{ copr_build_delete_form(build, page) }}
      </li>
    {% endif %}
    {% endif %}
    </ul>
  </div>
  {% endif %}
</div>
    

{% endif %}
{% endblock %}
